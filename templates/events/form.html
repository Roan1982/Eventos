{% extends 'base.html' %}
{% load form_tags %}

{% block content %}
<div class="container">
  <!-- Header -->
  <div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1>
          <i class="{% if form.instance.pk %}fas fa-edit{% else %}fas fa-plus-circle{% endif %} text-primary"></i>
          {% if form.instance.pk %}Editar Evento{% else %}Crear Nuevo Evento{% endif %}
        </h1>
        <p class="lead text-muted">
          {% if form.instance.pk %}
            Actualiza los detalles de tu evento
          {% else %}
            Completa la información para publicar tu evento
          {% endif %}
        </p>
      </div>
      <a href="{% if form.instance.pk %}{{ form.instance.get_absolute_url }}{% else %}{% url 'events:list' %}{% endif %}" 
         class="btn btn-outline-secondary">
        <i class="fas fa-times"></i> Cancelar
      </a>
    </div>
  </div>

  {% if form.instance.pk %}
  <div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i>
    <strong>Información guardada:</strong>
    <div class="mt-2">
      <div><strong>Inicio:</strong> {{ form.instance.start_datetime|date:"d/m/Y H:i" }}</div>
      <div><strong>Fin:</strong> {{ form.instance.end_datetime|date:"d/m/Y H:i" }}</div>
      <div><strong>Estado:</strong> <span class="badge bg-secondary">{{ form.instance.get_status_display }}</span></div>
    </div>
  </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="eventForm">
    {% csrf_token %}
    
    {% if form.errors %}
    <div class="alert alert-danger mb-4">
      <h5 class="alert-heading">
        <i class="fas fa-exclamation-triangle"></i> Errores en el formulario
      </h5>
      <ul class="mb-0">
        {% for field, errors in form.errors.items %}
          <li><strong>{{ field }}</strong>: {{ errors|join:", " }}</li>
        {% endfor %}
        {% for e in form.non_field_errors %}
          <li>{{ e }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <!-- Sección 1: Información Básica -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-info-circle"></i> Información Básica
        </h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="id_title" class="form-label fw-bold">
            <i class="fas fa-heading"></i> Título del Evento *
          </label>
          {{ form.title|add_class:'form-control' }}
          <small class="form-text text-muted">Un título atractivo y descriptivo</small>
        </div>

        <div class="mb-3">
          <label for="id_description" class="form-label fw-bold">
            <i class="fas fa-align-left"></i> Descripción *
          </label>
          {{ form.description|add_class:'form-control' }}
          <small class="form-text text-muted">Describe tu evento en detalle. ¿Qué pueden esperar los asistentes?</small>
        </div>

        <div class="mb-3">
          <label for="id_category" class="form-label fw-bold">
            <i class="fas fa-tag"></i> Categoría *
          </label>
          {{ form.category|add_class:'form-select' }}
        </div>
      </div>
    </div>

    <!-- Sección 2: Fechas y Horarios -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-calendar-alt"></i> Fechas y Horarios
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="id_start_date" class="form-label fw-bold">
              <i class="fas fa-calendar-day"></i> Fecha de Inicio *
            </label>
            <input type="date" name="start_date" id="id_start_date" class="form-control" required
                   value="{{ form.start_date.value|default:'' }}">
          </div>
          <div class="col-md-6 mb-3">
            <label for="id_start_time" class="form-label fw-bold">
              <i class="fas fa-clock"></i> Hora de Inicio *
            </label>
            <input type="time" name="start_time" id="id_start_time" class="form-control" required
                   value="{{ form.start_time.value|default:'' }}">
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="id_end_date" class="form-label fw-bold">
              <i class="fas fa-calendar-check"></i> Fecha de Finalización *
            </label>
            <input type="date" name="end_date" id="id_end_date" class="form-control" required
                   value="{{ form.end_date.value|default:'' }}">
          </div>
          <div class="col-md-6 mb-3">
            <label for="id_end_time" class="form-label fw-bold">
              <i class="fas fa-clock"></i> Hora de Finalización *
            </label>
            <input type="time" name="end_time" id="id_end_time" class="form-control" required
                   value="{{ form.end_time.value|default:'' }}">
          </div>
        </div>
      </div>
    </div>

    <!-- Sección 3: Ubicación -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-map-marker-alt"></i> Ubicación
        </h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="id_venue_name" class="form-label fw-bold">
            <i class="fas fa-building"></i> Nombre del Lugar
          </label>
          {{ form.venue_name|add_class:'form-control' }}
          <small class="form-text text-muted">Ej: Teatro Nacional, Parque Central, etc.</small>
        </div>

        <div class="mb-3">
          <label for="id_address" class="form-label fw-bold">
            <i class="fas fa-road"></i> Dirección
          </label>
          {{ form.address|add_class:'form-control' }}
        </div>

        <div class="mb-3">
          <label for="id_city" class="form-label fw-bold">
            <i class="fas fa-city"></i> Ciudad *
          </label>
          {{ form.city|add_class:'form-control' }}
        </div>
      </div>
    </div>

    <!-- Sección 4: Detalles del Evento -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-cog"></i> Detalles del Evento
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="id_price" class="form-label fw-bold">
              <i class="fas fa-dollar-sign"></i> Precio
            </label>
            {{ form.price|add_class:'form-control' }}
            <small class="form-text text-muted">Deja en 0 para eventos gratuitos</small>
          </div>

          <div class="col-md-6 mb-3">
            <label for="id_capacity" class="form-label fw-bold">
              <i class="fas fa-users"></i> Capacidad
            </label>
            {{ form.capacity|add_class:'form-control' }}
            <small class="form-text text-muted">Número máximo de asistentes</small>
          </div>
        </div>

        <div class="mb-3">
          <label for="id_status" class="form-label fw-bold">
            <i class="fas fa-toggle-on"></i> Estado del Evento
          </label>
          {{ form.status|add_class:'form-select' }}
        </div>
      </div>
    </div>

    <!-- Sección 5: Multimedia -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-images"></i> Multimedia (Fotos y Videos)
        </h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="id_media_files" class="form-label fw-bold">
            <i class="fas fa-cloud-upload-alt"></i> Subir Archivos Nuevos
          </label>
          <input type="file" name="media_files" id="id_media_files" 
                 class="form-control" multiple accept="image/*,video/*" />
          <small class="form-text text-muted">
            Puedes seleccionar múltiples archivos. Formatos permitidos: JPG, PNG, GIF, MP4, etc.
          </small>
          <div id="mediaPreview" class="mt-3"></div>
        </div>

        {% if form.instance.pk and form.instance.media.count %}
        <hr>
        <h6 class="mb-3">
          <i class="fas fa-folder-open"></i> 
          Archivos Existentes ({{ form.instance.media.count }})
        </h6>
        <p class="text-muted small mb-3">
          <i class="fas fa-info-circle"></i> 
          Marca la opción <strong>"Portada"</strong> para establecer la imagen principal del evento.
          Marca <strong>"Eliminar"</strong> para quitar archivos que ya no necesitas.
        </p>
        
        <div class="row g-3">
          {% for m in form.instance.media.all %}
          <div class="col-6 col-sm-4 col-lg-3">
            <div class="card h-100 media-card-edit">
              <!-- Número del archivo -->
              <div class="media-number">{{ forloop.counter }}</div>
              
              <!-- Vista previa -->
              <div class="media-preview">
                {% if m.mime_main == 'image' %}
                  <img src="{% url 'events:media_blob' m.id %}" 
                       class="w-100" style="height:150px; object-fit:cover;" alt="{{ m.filename }}">
                {% elif m.mime_main == 'video' %}
                  <div class="ratio ratio-16x9">
                    <video class="w-100 h-100" muted>
                      <source src="{% url 'events:media_blob' m.id %}" type="{{ m.content_type }}">
                    </video>
                    <div class="video-overlay">
                      <i class="fas fa-play-circle fa-3x"></i>
                    </div>
                  </div>
                {% else %}
                  <div class="d-flex align-items-center justify-content-center bg-light" style="height:150px;">
                    <i class="fas fa-file fa-2x text-muted"></i>
                  </div>
                {% endif %}
              </div>
              
              <!-- Controles -->
              <div class="card-body p-2">
                <div class="text-muted small mb-2 text-truncate">
                  <i class="fas fa-file"></i> {{ m.filename }}
                </div>
                <div class="text-muted small mb-2">
                  <i class="fas fa-weight"></i> {{ m.size|filesizeformat }}
                </div>
                
                <!-- Opciones -->
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="cover_media" 
                         value="{{ m.id }}" id="cover_media_{{ m.id }}"
                         {% if form.instance.cover_media and form.instance.cover_media.id == m.id %}checked{% endif %}>
                  <label class="form-check-label small fw-bold text-success" for="cover_media_{{ m.id }}">
                    <i class="fas fa-star"></i> Portada
                  </label>
                </div>
                
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="delete_media" 
                         value="{{ m.id }}" id="del_media_{{ m.id }}">
                  <label class="form-check-label small fw-bold text-danger" for="del_media_{{ m.id }}">
                    <i class="fas fa-trash"></i> Eliminar
                  </label>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          No hay multimedia cargada todavía. Sube fotos o videos para hacer tu evento más atractivo.
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Botones de Acción -->
    <div class="d-flex gap-3 justify-content-between mb-5">
      <a href="{% if form.instance.pk %}{{ form.instance.get_absolute_url }}{% else %}{% url 'events:list' %}{% endif %}" 
         class="btn btn-outline-secondary btn-lg">
        <i class="fas fa-times"></i> Cancelar
      </a>
      <button type="submit" class="btn btn-primary btn-lg">
        <i class="fas fa-save"></i> 
        {% if form.instance.pk %}Guardar Cambios{% else %}Crear Evento{% endif %}
      </button>
    </div>
  </form>
</div>
{% endblock %}

