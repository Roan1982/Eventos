{% extends 'base.html' %}
{% block meta %}
  <meta property="og:title" content="{{ event.title }}">
  <meta property="og:description" content="{{ event.description|striptags|truncatechars:150 }}">
  <meta property="og:type" content="event">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
{% endblock %}
{% load form_tags from events.templatetags %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h1>{{ event.title }}</h1>
  {% if user == event.creator or user.is_superuser %}
  <div>
    <a class="btn btn-sm btn-outline-secondary" href="{{ event.get_absolute_url }}editar/">Editar</a>
    <a class="btn btn-sm btn-outline-danger" href="{{ event.get_absolute_url }}eliminar/">Eliminar</a>
  </div>
  {% endif %}
</div>
<p>
  <span class="badge bg-secondary">{{ event.category.name }}</span>
  <span class="ms-2">{{ event.city }}</span>
  {% if event.is_free %}<span class="badge bg-success ms-2">Gratis</span>{% else %}
  <span class="badge bg-info ms-2">${{ event.price }}</span>{% endif %}
</p>
<p>{{ event.description|linebreaks }}</p>

<div class="mb-3">
  <strong>Compartir: </strong>
  <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri|urlencode }}&text={{ event.title|urlencode }}">Twitter</a>
  <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}">Facebook</a>
  <a class="btn btn-sm btn-outline-success" target="_blank" href="https://wa.me/?text={{ request.build_absolute_uri|urlencode }}">WhatsApp</a>
  <a class="btn btn-sm btn-outline-info" target="_blank" href="https://t.me/share/url?url={{ request.build_absolute_uri|urlencode }}&text={{ event.title|urlencode }}">Telegram</a>
</div>

<div class="row">
  {% for m in event.media.all %}
  <div class="col-md-4 mb-3">
    {% if m.content_type.startswith('image') %}
      <img src="{% url 'events:media_blob' m.id %}" class="img-fluid rounded" alt="{{ m.filename }}">
    {% elif m.content_type.startswith('video') %}
      <video controls class="w-100">
        <source src="{% url 'events:media_blob' m.id %}" type="{{ m.content_type }}">
      </video>
    {% else %}
      <a href="{% url 'events:media_blob' m.id %}">{{ m.filename }}</a>
    {% endif %}
  </div>
  {% empty %}
  <p>Sin multimedia</p>
  {% endfor %}
</div>

<h3>Contacto</h3>
{% if event.creator.userprofile.allow_contact %}
  <p>
    {% if event.creator.email %}<a class="btn btn-sm btn-outline-secondary" href="mailto:{{ event.creator.email }}">Email</a>{% endif %}
    {% if event.creator.userprofile.contact_whatsapp %}<a class="btn btn-sm btn-outline-success" href="https://wa.me/{{ event.creator.userprofile.contact_whatsapp }}" target="_blank">WhatsApp</a>{% endif %}
    {% if event.creator.userprofile.contact_telegram %}<a class="btn btn-sm btn-outline-info" href="tg://resolve?domain={{ event.creator.userprofile.contact_telegram }}">Telegram</a>{% endif %}
  </p>
  <form action="{% url 'events:contact_creator' event.slug %}" method="post" class="mt-2">
    {% csrf_token %}
    <div class="mb-3">
      <label for="id_name" class="form-label">Nombre</label>
      {{ contact_form.name|add_class:'form-control' }}
    </div>
    <div class="mb-3">
      <label for="id_email" class="form-label">Email</label>
      {{ contact_form.email|add_class:'form-control' }}
    </div>
    <div class="mb-3">
      <label for="id_message" class="form-label">Mensaje</label>
      {{ contact_form.message|add_class:'form-control' }}
    </div>
    <button class="btn btn-primary">Enviar mensaje</button>
  </form>
{% else %}
  <p>El creador no acepta mensajes directos.</p>
{% endif %}

<h3 class="mt-4">Reseñas</h3>
<p>Promedio: ⭐ {{ avg_rating|floatformat:1 }}</p>
{% for r in event.reviews.all %}
  <div class="border rounded p-2 mb-2">
    <strong>⭐ {{ r.rating }}</strong> - {{ r.user.username }}
    <p class="mb-1">{{ r.comment }}</p>
    {% if user.is_superuser or user == event.creator %}
      <a class="btn btn-sm btn-outline-danger" href="{% url 'events:delete_review' r.id %}">Eliminar</a>
    {% endif %}
  </div>
{% empty %}
  <p>No hay reseñas.</p>
{% endfor %}

{% if user.is_authenticated %}
<form action="{% url 'events:add_review' event.slug %}" method="post" class="mt-3">
  {% csrf_token %}
  <div class="mb-3">
    <label for="id_rating" class="form-label">Puntuación</label>
    {{ review_form.rating|add_class:'form-select' }}
  </div>
  <div class="mb-3">
    <label for="id_comment" class="form-label">Comentario</label>
    {{ review_form.comment|add_class:'form-control' }}
  </div>
  <button class="btn btn-primary">Enviar reseña</button>
</form>
{% else %}
<p><a href="/accounts/login/">Inicia sesión</a> para dejar una reseña.</p>
{% endif %}
{% endblock %}
