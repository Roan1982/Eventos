{% extends 'base.html' %}

{% block meta %}
  <meta property="og:title" content="{{ event.title }}">
  <meta property="og:description" content="{{ event.description|striptags|truncatechars:150 }}">
  <meta property="og:type" content="event">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
{% endblock %}

{% load form_tags %}

{% block content %}
<!-- Hero Section con Imagen de Portada -->
<div class="event-hero mb-5">
  {% with media_list=media_list %}
    {% if event.cover_media %}
      <div class="event-hero-image">
        <img src="{% url 'events:media_blob' event.cover_media.id %}" alt="{{ event.title }}">
      </div>
    {% elif media_list %}
      <div class="event-hero-image">
        <img src="{% url 'events:media_blob' media_list.0.id %}" alt="{{ event.title }}">
      </div>
    {% else %}
      <div class="event-hero-image" style="background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); min-height: 400px;"></div>
    {% endif %}
  {% endwith %}
  
  <div class="event-hero-overlay">
    <div class="container">
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
          <h1 class="display-4 fw-bold text-white mb-3">{{ event.title }}</h1>
          
          <div class="event-meta-hero mb-3">
            <span class="badge badge-hero me-2">
              <i class="fas fa-tag"></i> {{ event.category.name }}
            </span>
            {% if event.featured %}
            <span class="badge badge-featured me-2">
              <i class="fas fa-star"></i> Destacado
            </span>
            {% endif %}
            {% if event.is_free %}
            <span class="badge bg-success me-2">
              <i class="fas fa-gift"></i> Gratis
            </span>
            {% else %}
            <span class="badge bg-light text-dark me-2">
              <i class="fas fa-ticket-alt"></i> ${{ event.price }}
            </span>
            {% endif %}
          </div>
          
          <div class="event-info-blocks">
            <div class="info-block">
              <i class="fas fa-calendar text-white"></i>
              <div class="ms-2">
                <small class="text-white-50 d-block">Inicio</small>
                <span class="text-white">{{ event.start_datetime|date:"d M, Y - H:i" }}</span>
              </div>
            </div>
            {% if event.end_datetime %}
            <div class="info-block">
              <i class="fas fa-calendar-check text-white"></i>
              <div class="ms-2">
                <small class="text-white-50 d-block">Fin</small>
                <span class="text-white">{{ event.end_datetime|date:"d M, Y - H:i" }}</span>
              </div>
            </div>
            {% endif %}
            <div class="info-block">
              <i class="fas fa-map-marker-alt text-white"></i>
              <div class="ms-2">
                <small class="text-white-50 d-block">Ubicación</small>
                <span class="text-white">{{ event.city }}{% if event.address %}, {{ event.address }}{% endif %}</span>
              </div>
            </div>
            <div class="info-block">
              <i class="fas fa-user text-white"></i>
              <div class="ms-2">
                <small class="text-white-50 d-block">Organizado por</small>
                <span class="text-white">{{ event.creator.username }}</span>
              </div>
            </div>
            <div class="info-block">
              <i class="fas fa-eye text-white"></i>
              <div class="ms-2">
                <small class="text-white-50 d-block">Visto</small>
                <span class="text-white">{{ event.view_count }} veces</span>
              </div>
            </div>
          </div>
        </div>
        
        {% if user == event.creator or user.is_superuser %}
        <div class="ms-3">
          <a class="btn btn-light mb-2 d-block" href="{{ event.get_absolute_url }}editar/">
            <i class="fas fa-edit"></i> Editar
          </a>
          <a class="btn btn-outline-light d-block" href="{{ event.get_absolute_url }}eliminar/">
            <i class="fas fa-trash"></i> Eliminar
          </a>
        </div>
        {% elif user.is_authenticated %}
        <div class="ms-3">
          <a href="{% url 'events:toggle_favorite' event.slug %}" 
             class="btn {% if is_favorited %}btn-danger{% else %}btn-outline-danger{% endif %} mb-2 d-block favorite-toggle-btn">
            <i class="fas fa-heart"></i> 
            {% if is_favorited %}
              En Favoritos
            {% else %}
              Agregar a Favoritos
            {% endif %}
          </a>
          <a href="{% url 'events:add_to_calendar' event.slug %}" 
             class="btn btn-outline-light d-block"
             title="Descargar evento para tu calendario">
            <i class="fas fa-calendar-plus"></i> Agregar al Calendario
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Contenido Principal -->
<div class="container mb-5">
  <div class="row">
    <!-- Columna Principal -->
    <div class="col-lg-8">
      <!-- Descripción -->
      <div class="card mb-4">
        <div class="card-body">
          <h3 class="card-title">
            <i class="fas fa-info-circle text-primary"></i> Descripción
          </h3>
          <div class="event-description">
            {{ event.description|linebreaks }}
          </div>
        </div>
      </div>
      
      <!-- Mapa de Ubicación -->
      {% if event.address or event.city %}
      <div class="card mb-4">
        <div class="card-body">
          <h3 class="card-title">
            <i class="fas fa-map-marked-alt text-primary"></i> Ubicación del Evento
          </h3>
          <div class="mb-3">
            <p class="mb-1">
              <i class="fas fa-map-marker-alt text-danger"></i> 
              <strong>{{ event.venue_name|default:"Sin nombre de lugar" }}</strong>
            </p>
            {% if event.address %}
            <p class="mb-1 text-muted">
              <i class="fas fa-road"></i> {{ event.address }}
            </p>
            {% endif %}
            <p class="mb-0 text-muted">
              <i class="fas fa-city"></i> {{ event.city }}
            </p>
          </div>
          <div id="event-map" style="height: 400px; border-radius: 0.5rem;" 
               data-address="{{ event.address|default:'' }}" 
               data-city="{{ event.city }}"
               data-venue="{{ event.venue_name|default:'' }}">
          </div>
          <small class="text-muted d-block mt-2">
            <i class="fas fa-info-circle"></i> Mapa aproximado basado en la dirección proporcionada
          </small>
        </div>
      </div>
      {% endif %}
      
      <!-- Galería de Media -->
      {% with media_list=media_list %}
        {% if media_list %}
        <div class="card mb-4">
          <div class="card-body">
            <h3 class="card-title">
              <i class="fas fa-images text-primary"></i> Multimedia ({{ media_list|length }})
            </h3>
            
            <!-- Visor principal -->
            <div id="mainMediaWrapper" class="mb-3">
              {% with m=event.cover_media|default:media_list.0 %}
                {% if m.mime_main == 'image' %}
                  <img id="mainMedia" src="{% url 'events:media_blob' m.id %}" 
                       class="img-fluid w-100 rounded" alt="{{ m.filename }}" 
                       style="height:400px; object-fit:cover;">
                {% elif m.mime_main == 'video' %}
                  <video id="mainMedia" controls class="w-100 rounded" style="height:400px; object-fit:cover;">
                    <source src="{% url 'events:media_blob' m.id %}" type="{{ m.content_type }}">
                  </video>
                {% else %}
                  <a id="mainMedia" href="{% url 'events:media_blob' m.id %}" class="btn btn-outline-primary">
                    <i class="fas fa-download"></i> {{ m.filename }}
                  </a>
                {% endif %}
              {% endwith %}
            </div>
            
            <!-- Thumbnails carousel -->
            <div id="gallery" data-media='[
              {% for m in media_list %}
                {"id":{{ m.id }}, "url":"{% url 'events:media_blob' m.id %}", "mime":"{{ m.mime_main }}", "ctype":"{{ m.content_type|escapejs }}", "filename":"{{ m.filename|escapejs }}" }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ]'>
              <div class="d-flex justify-content-center align-items-center">
                <button id="prevBtn" class="btn btn-sm btn-outline-secondary me-2" style="height: 40px;">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <div id="thumbs" class="d-flex gap-2 justify-content-center flex-grow-1" style="max-width: 600px;">
                  <div class="thumb-slot" data-pos="prev" style="width:140px; height:100px;"></div>
                  <div class="thumb-slot active" data-pos="current" style="width:140px; height:100px;"></div>
                  <div class="thumb-slot" data-pos="next" style="width:140px; height:100px;"></div>
                </div>
                <button id="nextBtn" class="btn btn-sm btn-outline-secondary ms-2" style="height: 40px;">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      {% endwith %}
      
      <!-- Reseñas -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="card-title mb-0">
              <i class="fas fa-star text-warning"></i> Reseñas
            </h3>
          </div>
          
          <!-- Promedio de calificaciones -->
          {% if avg_rating %}
          <div class="avg-rating-container">
            <div class="avg-rating-number">{{ avg_rating|floatformat:1 }}</div>
            <div>
              <div class="star-rating avg-rating-stars" data-rating="{{ avg_rating }}">
                <span class="star"></span>
                <span class="star"></span>
                <span class="star"></span>
                <span class="star"></span>
                <span class="star"></span>
              </div>
              <div class="avg-rating-count">{{ review_count }} reseña{{ review_count|pluralize }}</div>
            </div>
          </div>
          {% endif %}
          
          <!-- Lista de reseñas -->
          <div class="reviews-list mb-4">
            {% for r in event.reviews.all %}
            <div class="review-item border rounded p-3 mb-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <strong class="text-primary">
                    <i class="fas fa-user-circle"></i> {{ r.user.username }}
                  </strong>
                  <div class="star-rating review-stars" data-rating="{{ r.rating }}">
                    <span class="star"></span>
                    <span class="star"></span>
                    <span class="star"></span>
                    <span class="star"></span>
                    <span class="star"></span>
                  </div>
                  <small class="text-muted">
                    <i class="fas fa-clock"></i> {{ r.created_at|date:"d/m/Y H:i" }}
                  </small>
                </div>
                {% if user.is_staff or user.is_superuser %}
                <a class="btn btn-sm btn-outline-danger" href="{% url 'events:delete_review' r.id %}" 
                   onclick="return confirm('¿Eliminar esta reseña?')">
                  <i class="fas fa-trash"></i>
                </a>
                {% endif %}
              </div>
              {% if r.comment %}
              <p class="mb-0">{{ r.comment }}</p>
              {% endif %}
            </div>
            {% empty %}
            <div class="alert alert-info text-center">
              <i class="fas fa-comment-slash fa-2x mb-2 d-block"></i>
              <p class="mb-0">No hay reseñas todavía. ¡Sé el primero en opinar!</p>
            </div>
            {% endfor %}
          </div>
          
          <!-- Formulario de reseña -->
          {% if user.is_authenticated %}
          <div class="add-review-form">
            <h5 class="mb-3"><i class="fas fa-pen"></i> Deja tu reseña</h5>
            <form action="{% url 'events:add_review' event.slug %}" method="post">
              {% csrf_token %}
              
              <!-- Star Rating Input -->
              <div class="review-form-stars">
                <label><i class="fas fa-star text-warning"></i> Tu Calificación</label>
                <div class="star-rating interactive">
                  <span class="star"></span>
                  <span class="star"></span>
                  <span class="star"></span>
                  <span class="star"></span>
                  <span class="star"></span>
                </div>
                {{ review_form.rating }}
                <small class="d-block mt-2 text-muted">Haz clic en las estrellas para calificar (puedes dar medias estrellas)</small>
              </div>
              
              <div class="mb-3">
                <label for="id_comment" class="form-label">
                  <i class="fas fa-comment"></i> Comentario (opcional)
                </label>
                {{ review_form.comment }}
              </div>
              
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Enviar Reseña
              </button>
            </form>
          </div>
          {% else %}
          <div class="alert alert-warning">
            <i class="fas fa-lock"></i> 
            <a href="{% url 'accounts:login' %}">Inicia sesión</a> para dejar una reseña.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Compartir -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-share-alt text-primary"></i> Compartir Evento
          </h5>
          <div class="d-grid gap-2">
            <a class="btn btn-outline-primary btn-sm" target="_blank" 
               href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri|urlencode }}&text={{ event.title|urlencode }}">
              <i class="fab fa-twitter"></i> Twitter
            </a>
            <a class="btn btn-outline-primary btn-sm" target="_blank" 
               href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}">
              <i class="fab fa-facebook"></i> Facebook
            </a>
            <a class="btn btn-outline-success btn-sm" target="_blank" 
               href="https://wa.me/?text={{ event.title|urlencode }}%20{{ request.build_absolute_uri|urlencode }}">
              <i class="fab fa-whatsapp"></i> WhatsApp
            </a>
            <a class="btn btn-outline-info btn-sm" target="_blank" 
               href="https://t.me/share/url?url={{ request.build_absolute_uri|urlencode }}&text={{ event.title|urlencode }}">
              <i class="fab fa-telegram"></i> Telegram
            </a>
          </div>
        </div>
      </div>
      
      <!-- Contacto con el Organizador -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-envelope text-primary"></i> Contactar Organizador
          </h5>
          
          {% if event.creator.userprofile.allow_contact %}
            <!-- Botones rápidos -->
            <div class="d-grid gap-2 mb-3">
              {% if event.creator.email %}
              <a class="btn btn-outline-secondary btn-sm" href="mailto:{{ event.creator.email }}">
                <i class="fas fa-envelope"></i> Email
              </a>
              {% endif %}
              {% if event.creator.userprofile.contact_whatsapp %}
              <a class="btn btn-outline-success btn-sm" href="https://wa.me/{{ event.creator.userprofile.contact_whatsapp }}" target="_blank">
                <i class="fab fa-whatsapp"></i> WhatsApp
              </a>
              {% endif %}
              {% if event.creator.userprofile.contact_telegram %}
              <a class="btn btn-outline-info btn-sm" href="tg://resolve?domain={{ event.creator.userprofile.contact_telegram }}">
                <i class="fab fa-telegram"></i> Telegram
              </a>
              {% endif %}
            </div>
            
            <hr>
            
            <!-- Formulario de contacto -->
            <form action="{% url 'events:contact_creator' event.slug %}" method="post">
              {% csrf_token %}
              <div class="mb-2">
                <label for="id_name" class="form-label small">Nombre</label>
                {{ contact_form.name|add_class:'form-control form-control-sm' }}
              </div>
              <div class="mb-2">
                <label for="id_email" class="form-label small">Email</label>
                {{ contact_form.email|add_class:'form-control form-control-sm' }}
              </div>
              <div class="mb-2">
                <label for="id_message" class="form-label small">Mensaje</label>
                {{ contact_form.message|add_class:'form-control form-control-sm' }}
              </div>
              <button class="btn btn-primary btn-sm w-100">
                <i class="fas fa-paper-plane"></i> Enviar Mensaje
              </button>
            </form>
          {% else %}
            <p class="text-muted small mb-0">
              <i class="fas fa-ban"></i> El organizador no acepta mensajes directos.
            </p>
          {% endif %}
        </div>
      </div>
      
      <!-- Eventos Relacionados -->
      {% if related_events %}
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-calendar-alt text-primary"></i> Eventos Similares
          </h5>
          <div class="list-group list-group-flush">
            {% for re in related_events %}
            <a href="{{ re.get_absolute_url }}" class="list-group-item list-group-item-action p-2">
              <div class="d-flex gap-2">
                {% if re.cover_media %}
                <img src="{% url 'events:media_blob' re.cover_media.id %}" 
                     alt="{{ re.title }}" class="rounded" 
                     style="width: 60px; height: 60px; object-fit: cover;">
                {% else %}
                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                     style="width: 60px; height: 60px;">
                  <i class="fas fa-calendar text-muted"></i>
                </div>
                {% endif %}
                <div class="flex-grow-1" style="min-width: 0;">
                  <h6 class="mb-1 text-truncate">{{ re.title }}</h6>
                  <small class="text-muted d-block">
                    <i class="fas fa-calendar"></i> {{ re.start_datetime|date:"d M" }}
                  </small>
                  <small class="text-muted">
                    <i class="fas fa-map-marker-alt"></i> {{ re.city }}
                  </small>
                </div>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

